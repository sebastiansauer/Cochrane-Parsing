---
title: "01-Cochrane-Scraping"
ipsum_meta:
  twitter_card: "Summary info for the Twitter Card"
  twitter_site: "\\@sitehandle"
  twitter_creator: "\\@creatorhandle"
  og_url: "https\\://example.com/open/graph/finalURLfor/this"
  og_description: "A modest size description of the content"
  og_image: "https\\://example.com/open/graph/imageURLfor/this"
output: 
  hrbrthemes::ipsum:
    toc: true
    number_section: TRUE
editor_options: 
  chunk_output_type: console
---


# Setup

```{r include=FALSE}
knitr::opts_chunk$set(fig.retina = 2)
```

```{r ipsum_setup, message=FALSE, warning=FALSE, cache=FALSE, echo=FALSE}
library(hrbrthemes)
library(tidyverse)  # data wrangling
library(rvest)  # web scraping
library(xml2)  # web scraping
library(stringr)  # string manipulation
library(printr)  # print dfs as tables
library(glue)  # glueing
library(rcrossref)  # citation coutn
update_geom_font_defaults(font_rc)
```



# Define pages to be scraped


```{r}
source("data/dois-reviews.R")
dois_list <- readxl::read_xlsx("data/doi-list-reviewer.xlsx")
dois_jh <- dois_list %>% 
  filter(reviewer == "JH")

dois_hw <- dois_list %>% 
  filter(reviewer == "HW") %>% 
  pull(url)
```



```{r}
# mindfulness open access review on intervention:
# friendly review:
mindfulness_url <- "https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD012791.pub2/full"


cochrane_url <- dois_reviews_paywalled[1]

# paywalled url:
paywalled_url <- "https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD013879/full"

# friendly review:
friendly_url <- "http://dx.doi.org/10.1002/14651858.CD003474.pub4"

# no "summary of findings table"
nosumtable_url <- "https://doi.org/10.1002/14651858.CD009326.pub3"


# not recent review:
old_version_url <- "https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD001352/full"


url_throws_error <- "http://dx.doi.org/10.1002/14651858.CD000245.pub4"

url_withdrawn <- "https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD004125.pub3/full"

url_jh1 <- dois_jh[1]

review_url <- mindfulness_url 
```




# Source functions to get main study infos

```{r}
source("funs-parse-cochrane.R")
source("get_summary_table.R")
```







# Test run: parse one review

```{r}
review <- list()
  
  review$page_content <- read_html(review_url)  
  review$metadata <- get_review_metadata(review$page_content)
  review$abstract <- get_abstract(review$page_content)
  
  
  #debug(get_nr_of_summary_tables)
  
  #undebug(get_nr_of_summary_tables)
  review$number_of_summary_tables <- get_nr_of_summary_tables(review$page_content)
  
  
  #debug(get_summary_table)
   
  review$summarytable1 <- get_summary_table(review$page_content)
  review$summaryTable_metadata <- get_summary_table_metadata(review$page_content)
  
  #undebug(add_metadata_to_summary_table)
  review$final_table <- concat_tables(
    page_content = review$page_content,
    summarytable = review$summarytable1,
    metadata_review =  review$metadata,
    abstract_review = review$abstract,
    metadata_summaryTable = review$summaryTable_metadata)
```






## Test it

```{r test-parse-review}
test_review <- parse_review(review_url, overwrite = TRUE)
test_review <- parse_review(review_url, overwrite = TRUE)
test_review <- parse_review(mindfulness_url, overwrite = TRUE)
```



## init

```{r}
count_reviews <<- 1
```


## Loop

### JH

```{r}
  # init count:
  count_reviews <<- 1
```


```{r}
dois_jh1 <-
  dois_jh %>% 
  slice(80:100) %>% 
  pull(url) 

review_jh1 <- 
  dois_jh1 %>% 
  map_dfr(parse_review, .id = "id_review", output_dir = "output/jh",
          overwrite_file = FALSE)
```



```{r}
writexl::write_xlsx(review_jh1, path = "output/reviews_jh1.xlsx")
```



### HW

```{r}
reviews_parsed_hw <-
  dois_hw %>% 
  magrittr::extract(49:50) %>% 
  map_dfr(parse_review, output_dir = "output/hw")
```

```{r}
reviews_parsed_hw 
```

```{r}
writexl::write_xlsx(reviews_parsed_hw, path = "output/hw/reviews_hw.xlsx")
```







```{r}
reviews_parsed4 <- 
   dois_reviews_2017[43:50] %>% 
  # c(nosumtable_url, mindfulness_url, old_version_url) %>% 
   #old_version_url %>% 
   map_dfr(parse_review, .id = "id_review")
```



# Convert to data frame


```{r}
reviews_parsed2 <- 
   reviews_parsed %>% 
   mutate(review_id = duplicated(doi)) %>% 
   select(review_id, doi, everything())
```




# Save to disk


```{r}
write_csv(reviews_parsed3, 
            file = paste0("test_reviews_infos3", ".csv"))

writexl::write_xlsx(reviews_parsed3,
                    path = "test_reviews_infos3.xlsx")
```






```{r bib, include=FALSE}
# KEEP THIS AT THE END OF THE DOCUMENT TO GENERATE A LOCAL bib FILE FOR PKGS USED
knitr::write_bib(sub("^package:", "", grep("package", search(), value=TRUE)), file='skeleton.bib')
```